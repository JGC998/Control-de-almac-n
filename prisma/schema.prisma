generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// --- MODELOS DE DATOS PRINCIPALES ---

model Cliente {
  id           String        @id @default(uuid())
  nombre       String        @unique
  email        String?
  direccion    String?
  telefono     String?
  tier         String?
  pedidos      Pedido[]
  presupuestos Presupuesto[]
  precios      PrecioEspecial[]
  
  // CORREGIDO: Añadir la relación inversa a Producto
  productos    Producto[] 
}

model Producto {
  id             String @id @default(uuid())
  nombre         String
  
  referenciaFabricante String? @map("referencia_fab")
  espesor        Float?
  largo          Float?
  ancho          Float?
  precioUnitario Float
  pesoUnitario   Float
  costoUnitario  Float? @map("costo") 
  
  tieneTroquel   Boolean? @default(false)
  
  // RELACIONES
  cliente   Cliente? @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  clienteId String? 

  // FIX: Se establece onDelete: Restrict para que no se pueda borrar si tiene productos
  fabricante   Fabricante? @relation(fields: [fabricanteId], references: [id], onDelete: Restrict)
  fabricanteId String?
  
  // FIX: Se establece onDelete: Restrict para que no se pueda borrar si tiene productos
  material     Material?   @relation(fields: [materialId], references: [id], onDelete: Restrict)
  materialId   String? 

  // Otros
  itemsPedido PedidoItem[]
  itemsPresup PresupuestoItem[]
  precios     PrecioEspecial[]
  
  @@map("Producto")
}

model Fabricante {
  id        String     @id @default(uuid())
  nombre    String     @unique
  productos Producto[]
}

model Material {
  id        String     @id @default(uuid())
  nombre    String     @unique
  productos Producto[]
  tarifas   TarifaMaterial[] // Añadir la relación de regreso a Tarifas (opcional, pero buena práctica)
}

model Pedido {
  id            String       @id @default(uuid())
  numero        String       @unique
  fechaCreacion DateTime     @default(now())
  estado        String
  notas         String?
  subtotal      Float
  tax           Float
  total         Float

  cliente   Cliente? @relation(fields: [clienteId], references: [id])
  clienteId String?

  presupuesto   Presupuesto? @relation(fields: [presupuestoId], references: [id], onDelete: SetNull)
  presupuestoId String?      @unique

  items PedidoItem[]
}

model PedidoItem {
  id           String  @id @default(uuid())
  descripcion  String
  quantity     Int
  unitPrice    Float
  pesoUnitario Float

  pedido   Pedido @relation(fields: [pedidoId], references: [id], onDelete: Restrict)
  pedidoId String

  producto   Producto? @relation(fields: [productoId], references: [id], onDelete: SetNull)
  productoId String?
}

model Presupuesto {
  id            String    @id @default(uuid())
  numero        String    @unique
  fechaCreacion DateTime  @default(now())
  estado        String
  notas         String?
  subtotal      Float
  tax           Float
  total         Float

  cliente   Cliente? @relation(fields: [clienteId], references: [id])
  clienteId String?

  items  PresupuestoItem[]
  pedido Pedido?
}

model PresupuestoItem {
  id          String   @id @default(uuid())
  description String
  quantity    Int
  unitPrice   Float

  presupuesto   Presupuesto @relation(fields: [presupuestoId], references: [id], onDelete: Restrict)
  presupuestoId String

  producto   Producto? @relation(fields: [productoId], references: [id], onDelete: SetNull)
  productoId String?
}

// --- MODELOS DE ALMACÉN Y PROVEEDORES ---

model Proveedor {
  id        String   @id @default(uuid())
  nombre    String   @unique
  email     String?
  telefono  String?
  direccion String?

  pedidos PedidoProveedor[]
}

model Stock {
  id                String   @id @default(uuid())
  material          String
  espesor           Float?
  metrosDisponibles Float
  proveedor         String?
  ubicacion         String?
  fechaEntrada      DateTime @default(now())
  costoMetro        Float?
  stockMinimo       Float?
  movimientos MovimientoStock[]
}

model MovimientoStock {
  id         String   @id @default(uuid())
  tipo       String
  cantidad   Float
  fecha      DateTime @default(now())
  referencia String?
  stockItem Stock  @relation(fields: [stockId], references: [id], onDelete: Restrict)
  stockId   String
}

model PedidoProveedor {
  id        String   @id @default(uuid())
  material  String
  fecha     DateTime @default(now())
  estado    String
  tipo      String   // "NACIONAL" | "IMPORTACION"
  notas     String?
  
  numeroContenedor String?
  naviera          String?
  fechaLlegadaEstimada DateTime?

  tasaCambio    Float? @default(1)
  gastosTotales Float? @default(0)

  proveedor   Proveedor @relation(fields: [proveedorId], references: [id], onDelete: Restrict)
  proveedorId String

  bobinas BobinaPedido[]
}

model BobinaPedido {
  id              String  @id @default(uuid())
  ancho           Float?
  largo           Float?
  espesor         Float?
  precioMetro     Float
  color           String?
  costoFinalMetro Float?
  
  referencia   ReferenciaBobina? @relation(fields: [referenciaId], references: [id], onDelete: SetNull)
  referenciaId String?
  
  pedido   PedidoProveedor @relation(fields: [pedidoId], references: [id], onDelete: Restrict)
  pedidoId String
}

// --- MODELOS DE CONFIGURACIÓN Y REGLAS ---

model TarifaMaterial {
  id       String @id @default(uuid())
  
  // FIX: Usar ID de Material con Foreign Key RESTRICT
  material   Material @relation(fields: [materialId], references: [id], onDelete: Restrict)
  materialId String
  
  espesor  Float  
  precio   Float
  peso     Float
  @@unique([materialId, espesor]) // FIX: Cambiar a materialId
}

model ReferenciaBobina {
  id           String @id @default(uuid())
  referencia   String @unique @map("nombre")
  ancho        Float?
  lonas        Int?
  pesoPorMetroLineal Float?
  bobinas BobinaPedido[]
  
  @@map("ReferenciaBobina")
}

model ReglaMargen {
  id          String  @id @default(uuid())
  descripcion String
  tipo        String
  categoria   String?
  valor       Float
}

model ReglaDescuento {
  id          String    @id @default(uuid())
  descripcion String
  tipo        String
  categoria   String?
  tierCliente String?
  descuento   Float
  fechaInicio DateTime?
  fechaFin    DateTime?
  tiers       DescuentoTier[]
}

model DescuentoTier {
  id             String  @id @default(uuid())
  cantidadMinima Int
  descuento      Float
  regla   ReglaDescuento @relation(fields: [reglaId], references: [id], onDelete: Restrict)
  reglaId String
}

model PrecioEspecial {
  id          String   @id @default(uuid())
  descripcion String
  precio      Float
  cliente   Cliente @relation(fields: [clienteId], references: [id], onDelete: Restrict)
  clienteId String
  producto   Producto @relation(fields: [productoId], references: [id], onDelete: Restrict)
  productoId String
  @@unique([clienteId, productoId])
}

model Nota {
  id      String   @id @default(uuid())
  content String
  fecha   DateTime @default(now())
}

model Config {
  id    String @id @default(uuid())
  key   String @unique
  value String
}
