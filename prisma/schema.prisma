generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Cliente {
  id           String           @id @default(uuid())
  nombre       String           @unique
  email        String?
  direccion    String?
  telefono     String?
  tier         String?
  pedidos      Pedido[]
  presupuestos Presupuesto[]
  precios      PrecioEspecial[]
  productos    Producto[]
}

model Producto {
  id                   String            @id @default(uuid())
  nombre               String
  referenciaFabricante String?           @map("referencia_fab")
  espesor              Float?
  largo                Float?
  ancho                Float?
  precioUnitario       Float
  pesoUnitario         Float
  costoUnitario        Float?            @map("costo")
  tieneTroquel         Boolean?          @default(false)
  clienteId            String?
  fabricanteId         String?
  materialId           String?
  precioVentaFab       Float?
  precioVentaInt       Float?
  precioVentaFin       Float?
  
  cliente              Cliente?          @relation(fields: [clienteId], references: [id])
  fabricante           Fabricante?       @relation(fields: [fabricanteId], references: [id])
  material             Material?         @relation(fields: [materialId], references: [id])
  
  documentos           Documento[]
  itemsPedido          PedidoItem[]
  itemsPresup          PresupuestoItem[]
  precios              PrecioEspecial[]

  @@map("Producto")
}

model Fabricante {
  id        String     @id @default(uuid())
  nombre    String     @unique
  productos Producto[]
}

model Material {
  id        String     @id @default(uuid())
  nombre    String     @unique
  productos Producto[]
}

model Pedido {
  id            String       @id @default(uuid())
  numero        String       @unique
  fechaCreacion DateTime     @default(now())
  estado        String
  notas         String?
  subtotal      Float
  tax           Float
  total         Float
  clienteId     String?
  presupuestoId String?      @unique
  marginId      String?
  
  cliente       Cliente?     @relation(fields: [clienteId], references: [id])
  presupuesto   Presupuesto? @relation(fields: [presupuestoId], references: [id])
  items         PedidoItem[]
}

model PedidoItem {
  id           String    @id @default(uuid())
  descripcion  String
  quantity     Int
  unitPrice    Float
  pesoUnitario Float
  pedidoId     String
  productoId   String?
  
  pedido       Pedido    @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  producto     Producto? @relation(fields: [productoId], references: [id], onDelete: Cascade)
}

model Presupuesto {
  id            String            @id @default(uuid())
  numero        String            @unique
  fechaCreacion DateTime          @default(now())
  estado        String
  notas         String?
  subtotal      Float
  tax           Float
  total         Float
  clienteId     String?
  marginId      String?
  
  cliente       Cliente?          @relation(fields: [clienteId], references: [id])
  items         PresupuestoItem[]
  pedido        Pedido?
}

model PresupuestoItem {
  id            String      @id @default(uuid())
  description   String
  quantity      Int
  unitPrice     Float
  presupuestoId String
  productoId    String?
  
  presupuesto   Presupuesto @relation(fields: [presupuestoId], references: [id], onDelete: Cascade)
  producto      Producto?   @relation(fields: [productoId], references: [id], onDelete: Cascade)
}

model Proveedor {
  id        String            @id @default(uuid())
  nombre    String            @unique
  email     String?
  telefono  String?
  direccion String?
  pedidos   PedidoProveedor[]
}

model Stock {
  id                String            @id @default(uuid())
  material          String
  espesor           Float?
  metrosDisponibles Float
  proveedor         String?
  ubicacion         String?
  fechaEntrada      DateTime          @default(now())
  costoMetro        Float?
  stockMinimo       Float?
  movimientos       MovimientoStock[]
}

model MovimientoStock {
  id         String   @id @default(uuid())
  tipo       String
  cantidad   Float
  fecha      DateTime @default(now())
  referencia String?
  stockId    String?
  stockItem  Stock?   @relation(fields: [stockId], references: [id], onDelete: SetNull)
}

model PedidoProveedor {
  id                   String         @id @default(uuid())
  material             String
  fecha                DateTime       @default(now())
  estado               String
  tipo                 String
  notas                String?
  numeroContenedor     String?
  numeroFactura        String?
  naviera              String?
  fechaLlegadaEstimada DateTime?
  tasaCambio           Float?         @default(1)
  gastosTotales        Float?         @default(0)
  proveedorId          String
  
  proveedor            Proveedor      @relation(fields: [proveedorId], references: [id])
  bobinas              BobinaPedido[]
}

model BobinaPedido {
  id              String           @id @default(uuid())
  cantidad        Int              @default(1) 
  ancho           Float?
  largo           Float?
  espesor         Float?
  precioMetro     Float
  color           String?
  costoFinalMetro Float            @default(0)
  referenciaId    String?
  pedidoId        String
  
  referencia      ReferenciaBobina? @relation(fields: [referenciaId], references: [id])
  pedido          PedidoProveedor   @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
}

model TarifaMaterial {
  id       String @id @default(uuid())
  material String
  espesor  Float
  precio   Float
  peso     Float
  @@unique([material, espesor])
}

model ReferenciaBobina {
  id                 String         @id @default(uuid())
  referencia         String         @map("nombre")
  ancho              Float?
  lonas              Int?
  pesoPorMetroLineal Float?
  bobinas            BobinaPedido[]
  @@unique([referencia, ancho, lonas])
  @@map("ReferenciaBobina")
}

model ReglaMargen {
  id            String  @id @default(uuid())
  base          String  @unique
  multiplicador Float
  gastoFijo     Float?
  descripcion   String
  tipo          String? @default("General")
  categoria     String? @map("tipo_categoria")
  tierCliente   String?
}

model ReglaDescuento {
  id          String          @id @default(uuid())
  descripcion String
  tipo        String
  categoria   String?
  tierCliente String?
  descuento   Float
  fechaInicio DateTime?
  fechaFin    DateTime?
  tiers       DescuentoTier[]
}

model DescuentoTier {
  id             String         @id @default(uuid())
  cantidadMinima Int
  descuento      Float
  reglaId        String
  regla          ReglaDescuento @relation(fields: [reglaId], references: [id], onDelete: Cascade)
}

model PrecioEspecial {
  id          String   @id @default(uuid())
  descripcion String
  precio      Float
  clienteId   String
  productoId  String
  
  cliente     Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  producto    Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)
  
  @@unique([clienteId, productoId])
}

model Documento {
  id               String   @id @default(uuid())
  tipo             String
  referencia       String
  descripcion      String?
  rutaArchivo      String
  fechaSubida      DateTime @default(now())
  productoId       String?
  maquinaUbicacion String?
  
  producto         Producto? @relation(fields: [productoId], references: [id], onDelete: SetNull)
  
  @@unique([referencia, rutaArchivo])
  @@map("Documento")
}

model Nota {
  id      String   @id @default(uuid())
  content String
  fecha   DateTime @default(now())
}

model Config {
  id    String @id @default(uuid())
  key   String @unique
  value String
}
