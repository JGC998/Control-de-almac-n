generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// --- MODELOS DE DATOS PRINCIPALES ---

model Cliente {
  id           String        @id @default(uuid())
  nombre       String        @unique
  email        String?
  direccion    String?
  telefono     String?
  tier         String?
  pedidos      Pedido[]
  presupuestos Presupuesto[]
  precios      PrecioEspecial[]
  
  // CORREGIDO: Añadir la relación inversa a Producto
  productos    Producto[] 
}

model Producto {
  id             String @id @default(uuid())
  nombre         String
  
  referenciaFabricante String? @map("referencia_fab")
  espesor        Float?
  largo          Float?
  ancho          Float?
  precioUnitario Float
  pesoUnitario   Float
  costoUnitario  Float? @map("costo") 
  
  tieneTroquel   Boolean? @default(false)
  
  // RELACIONES
  cliente   Cliente? @relation(fields: [clienteId], references: [id])
  clienteId String? 

  fabricante   Fabricante? @relation(fields: [fabricanteId], references: [id])
  fabricanteId String?
  material     Material?   @relation(fields: [materialId], references: [id])
  materialId   String?
  precioVentaFab Float?
  precioVentaInt Float?
  precioVentaFin Float?
  
  // Nuevo campo de relación con Documento (Planos/Guías)
  documentos      Documento[]

  // Otros
  itemsPedido PedidoItem[]
  itemsPresup PresupuestoItem[]
  precios     PrecioEspecial[]
  
  @@map("Producto")
}

model Fabricante {
  id        String     @id @default(uuid())
  nombre    String     @unique
  productos Producto[]
}

model Material {
  id        String     @id @default(uuid())
  nombre    String     @unique
  productos Producto[]
}

model Pedido {
  id            String       @id @default(uuid())
  numero        String       @unique
  fechaCreacion DateTime     @default(now())
  estado        String
  notas         String?
  subtotal      Float
  tax           Float
  total         Float

  cliente   Cliente? @relation(fields: [clienteId], references: [id])
  clienteId String?

  presupuesto   Presupuesto? @relation(fields: [presupuestoId], references: [id])
  presupuestoId String? @unique
  marginId String?

  items PedidoItem[]
}

model PedidoItem {
  id           String  @id @default(uuid())
  descripcion  String
  quantity     Int
  unitPrice    Float
  pesoUnitario Float

  pedido   Pedido @relation(fields: [pedidoId], references: [id])
  pedidoId String

  producto   Producto? @relation(fields: [productoId], references: [id])
  productoId String?
}

model Presupuesto {
  id            String    @id @default(uuid())
  numero        String    @unique
  fechaCreacion DateTime  @default(now())
  estado        String
  notas         String?
  subtotal      Float
  tax           Float
  total         Float

  cliente   Cliente? @relation(fields: [clienteId], references: [id])
  clienteId String?
  marginId String?

  items  PresupuestoItem[]
  pedido Pedido?
}

model PresupuestoItem {
  id          String   @id @default(uuid())
  description String
  quantity    Int
  unitPrice   Float

  presupuesto   Presupuesto @relation(fields: [presupuestoId], references: [id])
  presupuestoId String

  producto   Producto? @relation(fields: [productoId], references: [id])
  productoId String?
}

// --- MODELOS DE ALMACÉN Y PROVEEDORES ---

model Proveedor {
  id        String   @id @default(uuid())
  nombre    String   @unique
  email     String?
  telefono  String?
  direccion String?

  pedidos PedidoProveedor[]
}

model Stock {
  id                String   @id @default(uuid())
  material          String
  espesor           Float?
  metrosDisponibles Float
  proveedor         String?
  ubicacion         String?
  fechaEntrada      DateTime @default(now())
  costoMetro        Float?
  stockMinimo       Float?
  movimientos MovimientoStock[]
}

model MovimientoStock {
  id         String   @id @default(uuid())
  tipo       String
  cantidad   Float
  fecha      DateTime @default(now())
  referencia String?
  stockItem Stock? @relation(fields: [stockId], references: [id], onDelete: SetNull)
  stockId   String?
}

model PedidoProveedor {
  id        String   @id @default(uuid())
  material  String
  fecha     DateTime @default(now())
  estado    String
  tipo      String   // "NACIONAL" | "IMPORTACION"
  notas     String?
  
  numeroContenedor String?
  naviera          String?
  fechaLlegadaEstimada DateTime?

  tasaCambio    Float? @default(1)
  gastosTotales Float? @default(0)

  proveedor   Proveedor @relation(fields: [proveedorId], references: [id])
  proveedorId String

  bobinas BobinaPedido[]
}

model BobinaPedido {
  id              String  @id @default(uuid())
  ancho           Float?
  largo           Float?
  espesor         Float?
  precioMetro     Float
  color           String?
  costoFinalMetro Float  @default(0)
  
  referencia   ReferenciaBobina? @relation(fields: [referenciaId], references: [id])
  referenciaId String?
  pedido   PedidoProveedor @relation(fields: [pedidoId], references: [id])
  pedidoId String
}

// --- MODELOS DE CONFIGURACIÓN Y REGLAS ---

model TarifaMaterial {
  id       String @id @default(uuid())
  material String
  espesor  Float  
  precio   Float
  peso     Float
  @@unique([material, espesor])
}

model ReferenciaBobina {
  id           String @id @default(uuid())
  referencia   String @map("nombre")
  ancho        Float?
  lonas        Int?
  pesoPorMetroLineal Float?
  bobinas      BobinaPedido[]
  
  @@unique([referencia, ancho, lonas]) 
  @@map("ReferenciaBobina")
}

model ReglaMargen {
  id              String  @id @default(uuid())
  base            String  @unique 
  multiplicador   Float   
  gastoFijo       Float?
  
  descripcion     String 
  tipo            String? @default("General")
  categoria       String? @map("tipo_categoria") 
  tierCliente String?
}

model ReglaDescuento {
  id          String    @id @default(uuid())
  descripcion String
  tipo        String
  categoria   String?
  tierCliente String?
  descuento   Float
  fechaInicio DateTime?
  fechaFin    DateTime?
  tiers       DescuentoTier[]
}

model DescuentoTier {
  id             String  @id @default(uuid())
  cantidadMinima Int
  descuento      Float
  regla   ReglaDescuento @relation(fields: [reglaId], references: [id])
  reglaId String
}

model PrecioEspecial {
  id          String   @id @default(uuid())
  descripcion String
  precio      Float
  cliente   Cliente @relation(fields: [clienteId], references: [id])
  clienteId String
  producto   Producto @relation(fields: [productoId], references: [id])
  productoId String
  @@unique([clienteId, productoId])
}

// Modelo de Documentos (CORREGIDO: Eliminamos fechaPlano/version)
model Documento {
  id              String   @id @default(uuid())
  tipo            String   // "PLANO", "GUIA", "PROCESO"
  referencia      String   // La referencia o nombre del plano
  descripcion     String?  // Descripción del contenido
  rutaArchivo     String   // Campo para la URL o path del archivo
  fechaSubida     DateTime @default(now())

  // Relación opcional con el Producto (Planos)
  producto        Producto? @relation(fields: [productoId], references: [id])
  productoId      String?

  // Relación opcional con Maquinaria/Ubicación (Procesos, Guías)
  maquinaUbicacion String? 

  // MEJORA: Volvemos al constraint simple para evitar problemas de migración destructiva
  @@unique([referencia, rutaArchivo])
  @@map("Documento")
}


model Nota {
  id      String   @id @default(uuid())
  content String
  fecha   DateTime @default(now())
}

model Config {
  id    String @id @default(uuid())
  key   String @unique
  value String
}
